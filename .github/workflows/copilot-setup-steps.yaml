name: "Copilot Setup Steps"
# Copilot coding agents setup workflow (job name must be `copilot-setup-steps`)

on:
  workflow_dispatch:
  push:
    paths:
      - .github/workflows/copilot-setup-steps.yaml
  pull_request:
    paths:
      - .github/workflows/copilot-setup-steps.yaml

jobs:
  copilot-setup-steps:
    runs-on: ubuntu-latest

    # Copilot will use its own token later; keep this job read-only.
    permissions:
      contents: read
      packages: read
      id-token: write

    steps:
      - name: Checkout + cached LFS (nschloe)
        uses: nschloe/action-cached-lfs-checkout@v1.2.3
        with:
          fetch-depth: 1
          include: "*"
          exclude: ""
          # keep default behavior for LFS auth in private repos
          persist-credentials: true
          # enableCrossOsArchive: false
          # submodules: recursive   # uncomment if you actually use submodules

      # Root-cause fix: remove checkout token from the repo snapshot so the agent doesn't push as github-actions[bot]
      - name: Scrub checkout auth header (required for Copilot agent push)
        shell: bash
        run: |
          set -euxo pipefail
          git config --local --unset-all "http.https://github.com/.extraheader" || true
          git config --local --unset-all "credential.helper" || true

          if [ -f .gitmodules ]; then
            git submodule foreach --recursive \
              'git config --local --unset-all "http.https://github.com/.extraheader" || true; git config --local --unset-all "credential.helper" || true'
          fi

      # Optional: prove it's gone (useful while validating)
      - name: Debug (auth config should be empty now)
        shell: bash
        run: |
          set -euxo pipefail
          git config --local --show-origin --get-regexp \
            'http\..*extraheader|credential\.helper|url\..*insteadOf|core\.sshCommand|safe\.directory' || true
