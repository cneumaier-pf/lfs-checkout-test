name: "Copilot Setup Steps"
# This workflow sets up the environment for Copilot coding agents,
# see also https://docs.github.com/en/enterprise-cloud@latest/copilot/how-tos/use-copilot-agents/coding-agent/customize-the-agent-environment#setting-environment-variables-in-copilots-environment .

# Automatically run the setup steps when they are changed to allow for easy validation, and
# allow manual testing through the repository's "Actions" tab
on:
  workflow_dispatch:
  push:
    paths:
      - .github/workflows/copilot-setup-steps.yaml
  pull_request:
    paths:
      - .github/workflows/copilot-setup-steps.yaml

jobs:
  # The job MUST be called `copilot-setup-steps` or it will not be picked up by Copilot.
  copilot-setup-steps:
    runs-on: ubuntu-latest

    # Copilot will be given its own token for its operations.
    permissions:
      contents: read
      packages: read
      id-token: write


    # They mimic what we do to set up the env when running tests in the CI.
    steps:
      - name: Check out repository
        uses: nschloe/action-cached-lfs-checkout@v1.2.3
        # while this works:
        # uses: actions/checkout@v4
        # with:
        #   lfs: true


      - name: Debug git auth config
        shell: bash
        run: |
          set -euxo pipefail
          echo "== remotes =="
          git remote -v

          echo "== local auth-related config =="
          git config --local --show-origin --get-regexp \
            'http\..*extraheader|credential\.helper|url\..*insteadOf|core\.sshCommand|safe\.directory' || true

          echo "== submodules auth-related config =="
          if [ -f .gitmodules ]; then
            git submodule foreach --recursive \
              'git config --local --show-origin --get-regexp "http\..*extraheader|credential\.helper|url\..*insteadOf|core\.sshCommand|safe\.directory" || true'
          fi

